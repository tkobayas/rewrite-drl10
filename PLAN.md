# Plan for DRL Syntax Migration Recipes

- [x] Compare old vs new DRL grammars (`old-grammar/DRLParser.g4`, `old-grammar/DRL6Expressions.g4` vs `drools/drools-drl/drools-drl-parser/src/main/antlr4/org/drools/drl/parser/antlr4/DRL10Parser.g4`, `DRL10Expressions.g4`) to confirm unsupported constructs (half constraints, custom operators without `##`, infix `&&`/`||`). Findings: old `lhsExpression` accepted `OR/AND` tokens (infix `||`/`&&`), DRL10 limits to `DRL_OR/DRL_AND` (textual `or/and`); old `relationalExpression` + `orRestriction` allowed chained restrictions sharing the left side (e.g., `name == \"Mark\" || == \"Mario\"`), DRL10 requires each side be a full expression so half constraints are rejected; old `operator_key` allowed bare identifiers for custom operators, DRL10 requires `DRL_CUSTOM_OPERATOR_PREFIX` (`##`) before custom identifiers.
- [x] Inspect existing OpenRewrite setup under `openrewrite/rewrite` to see how DRL parsing/printing is wired and existing recipe patterns to extend. Findings: no existing DRL support; language modules (e.g., `rewrite-protobuf`) use `org.openrewrite.build.language-library` Gradle plugin, ANTLR grammars under `src/main/antlr`, generator task (`generateAntlrSources`), and `Parser` implementations plus printer/visitor classes. We can mirror this structure for a `rewrite-drl` module that reuses Drools grammars/visitors.
- [x] Decide parsing/rewrite approach (reuse Drools ANTLR in visitors vs token-level) and outline target AST nodes/tokens for each rule. Plan: build a `rewrite-drl` module mirroring `rewrite-protobuf`, reusing Drools DRL6 grammars (tolerant of legacy syntax) for parsing; implement visitors that work on parsed AST/ParseTree to produce `J`-like DRL tree or targeted token edits. Target hooks: for half-constraints, inspect `relationalExpression`/`orRestriction` chains where subsequent `singleRestriction` lacks a left operand and clone the previous LHS; for custom operators, detect `operator_key` tokens that are bare `IDENTIFIER` (not built-in) and prefix with `##`; for infix `&&`/`||`, detect `lhsExpression` forms using `OR`/`AND` tokens and rewrite tokens to textual `or`/`and` while preserving spacing/parentheses.
- [x] Specify rewrite rules in detail: half-constraint normalization, custom operator prefixing, logical operator replacements; define edge cases and non-goals. Details/edge cases:
  - Half-constraint: within pattern constraints, find chains `lhs (==/!=/relop/op) rhs1 || == rhs2` etc. Reconstruct missing left operand using the nearest preceding full relational expression. Handle `or`/`and` chains; preserve existing annotations and spacing. Do not rewrite if the following restriction already has an explicit left, or if preceding expr is not a simple relational (`RelationalExprDescr`/Atomic). Avoid inside `in`/`not in` list constructs (they already expand).
  - Custom operator: any binary restriction using a custom operator token parsed as bare `IDENTIFIER` (not built-in, not already prefixed) should be rewritten to `##<id>`. Leave built-in operators and already-prefixed `##foo` untouched. Maintain negated forms (`not <op>` â†’ `not ##<op>`).
  - Logical infix: replace `&&`/`||` (tokens `AND`/`OR`) with textual `and`/`or` only for `lhsExpression` connections (pattern composition). Do not rewrite logical operators inside constraint expressions. Avoid touching Java code in RHS or string literals/comments/identifiers. Preserve spacing/parentheses.
- [x] Set up standalone Gradle project with `rewrite-drl` module targeting OpenRewrite 8.68.1 (Java 17); ANTLR plugin wired and Drools DRL6 grammars copied into `rewrite-drl/src/main/antlr` for tolerant parsing.
- [x] Implement recipe classes (grouped under a DRL10 migration recipe list) with visitors for each transformation. Added heuristic PlainText visitors for half-constraints, custom operator prefixing, and LHS logical infix replacement; composite `DrlMigrationRecipe` to apply them.
- [ ] Revisit with AST/token-based recipes: replace regex heuristics by using the generated DRL6 parser with `TokenStreamRewriter` for precise edits (half-constraints, custom operator prefixing, LHS logical operator swaps).
- [x] Add focused tests with positive/negative cases ensuring formatting is preserved and output is DRL10-compatible (plain-text rewrite tests covering each recipe and the composite).
- [ ] Validate end-to-end on combined samples (optional DRL10 parse check) and adjust recipes as needed.
